<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="initial-scale=1" name="viewport" /><title>Padrino - Padrino and OmniAuth Overview</title><link href="../../../images/favicons/apple-touch-icon-57x57-75d6516e.png" rel="apple-touch-icon" sizes="57x57" /><link href="../../../images/favicons/apple-touch-icon-60x60-76221479.png" rel="apple-touch-icon" sizes="60x60" /><link href="../../../images/favicons/apple-touch-icon-72x72-7bd96522.png" rel="apple-touch-icon" sizes="72x72" /><link href="../../../images/favicons/apple-touch-icon-76x76-30739e4d.png" rel="apple-touch-icon" sizes="76x76" /><link href="../../../images/favicons/apple-touch-icon-114x114-1b1963ee.png" rel="apple-touch-icon" sizes="114x114" /><link href="../../../images/favicons/apple-touch-icon-144x144-b3992622.png" rel="apple-touch-icon" sizes="144x144" /><link href="../../../images/favicons/apple-touch-icon-152x152-48259d13.png" rel="apple-touch-icon" sizes="152x152" /><link href="../../../images/favicons/apple-touch-icon-180x180-b8e9ebf6.png" rel="apple-touch-icon" sizes="180x180" /><link href="../../../images/favicons/favicon-32x32-c7d41b6f.png" rel="icon" sizes="32x32" type="image/png" /><link href="../../../images/favicons/favicon-194x194-a2b53f7f.png" rel="icon" sizes="194x194" type="image/png" /><link href="../../../images/favicons/favicon-96x96-1f5cec29.png" rel="icon" sizes="96x96" type="image/png" /><link href="../../../images/favicons/android-chrome-192x192-a15741d5.png" rel="icon" sizes="192x192" type="image/png" /><link href="../../../images/favicons/favicon-16x16-609a9b93.png" rel="icon" sizes="16x16" type="image/png" /><link href="../../../images/favicons/manifest.json" rel="manifest" /><link color="#5bbad5" href="../../../images/favicons/safari-pinned-tab-a188e924.svg" rel="mask-icon" /><link href="/images/favicons/favicon.ico" rel="shortcut icon" /><meta content="#da532c" name="msapplication-TileColor" /><meta content="../../../images/favicons/mstile-144x144-c2018144.png" name="msapplication-TileImage" /><meta content="/images/favicons/browserconfig.xml" name="msapplication-config" /><meta content="#ffffff" name="theme-color" /><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><link href="../../../assets/stylesheets/all-7111719b.css" rel="stylesheet" /><script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script><script src="../../../assets/javascripts/all-1f8cd258.js"></script><link href="http://padrinorb.com/blog.rss" rel="alternate" title="Blog - Padrino Ruby Web Framework" type="application/rss+xml" /></head><body class="guides guides_08_advanced-usage guides_08_advanced-usage_08_padrino-and-omniauth-overview guides_08_advanced-usage_08_padrino-and-omniauth-overview_index"><div class="grid"><header class="header"><h1 class="header__name"><a class="padrino-name" href="/">Padrino</a></h1><div class="header__navigation"><nav class="navigation"><a class="navigation__toggler" href="#" id="navigation__toggler"><span class="navigation__toggler__icon fa fa-navicon"></span></a><ul class="navigation__items" id="navigation__items"><li class="navigation__item"><a class="navigation__link" href="/">Overview</a></li><li class="navigation__item"><a class="navigation__link--is-active" href="/guides/">Guides</a></li><li class="navigation__item"><a class="navigation__link" href="/blog/">Blog</a></li><li class="navigation__item"><a class="navigation__link" href="http://www.rubydoc.info/github/padrino/padrino-framework">API</a></li><li class="navigation__item"><a class="navigation__link" href="/contribute/">Contribute</a></li><li class="navigation__item"><a class="navigation__link" href="https://github.com/padrino/padrino-framework"><span class="button--slim">GitHub</span></a></li></ul></nav></div></header><div class="page"><div class="page__sidebar"><div class="sidebar"><h4 class="sidebar__header--first">Guides</h4><h5 class="sidebar__header"><a href="/guides/introduction/overview/">Introduction</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/introduction/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/introduction/why-learn-padrino/">Why Learn Padrino?</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/introduction/examples/">Examples</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/introduction/the-bleeding-edge/">The Bleeding Edge</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/introduction/press/">Press</a></li></ul><h5 class="sidebar__header"><a href="/guides/getting-started/overview/">Getting Started</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/getting-started/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/getting-started/basic-projects/">Basic Projects</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/getting-started/installation/">Installation</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/getting-started/blog-tutorial/">Blog Tutorial</a></li></ul><h5 class="sidebar__header"><a href="/guides/features/overview/">Features</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/padrino-admin/">Padrino Admin</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/padrino-mailer/">Padrino Mailer</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/padrino-cache/">Padrino Cache</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/mounting-applications/">Mounting Applications</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/development-commands/">Development Commands</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/extensions/">Extensions</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/localization/">Localization</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/features/rake-tasks/">Rake Tasks</a></li></ul><h5 class="sidebar__header"><a href="/guides/generators/overview/">Generators</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/projects/">Projects</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/plugins/">Plugins</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/controllers/">Controllers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/models/">Models</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/migrations/">Migrations</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/mailers/">Mailers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/sub-applications/">Sub-Applications</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/tiny-skeleton/">Tiny Skeleton</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/admin/">Admin</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/components/">Components</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/generators/tasks/">Tasks</a></li></ul><h5 class="sidebar__header"><a href="/guides/controllers/overview/">Controllers</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/routing/">Routing</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/layouts/">Layouts</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/provides-formats/">Provides Format</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/params-whitelisting/">Params Whitelisting</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/route-filters/">Route Filters</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/prioritized-routes/">Prioritized Routes</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/custom-conditions/">Custom Conditions</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/parsing-params/">Parsing Params</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/rendering/">Rendering</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/controllers/sessions/">Sessions</a></li></ul><h5 class="sidebar__header"><a href="/guides/application-helpers/overview/">Application Helpers</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/output-helpers/">Output Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/tag-helpers/">Tag Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/asset-helpers/">Asset Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/form-helpers/">Form Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/form-builders/">Form Builders</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/standard-form-builder/">Standard Form Builder</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/custom-form-builders/">Custom Form Builders</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/nested-object-form-support/">Nested Object Form Support</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/format-helpers/">Format Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/render-helpers/">Render Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/custom-helpers/">Custom Helpers</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/application-helpers/ujs-helpers/">Unobtrusive JavaScript Helpers</a></li></ul><h5 class="sidebar__header"><a href="/guides/adding-components/overview/">Adding Components</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/persistence-engine/">Persistence Engine</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/javascript-engine/">JavaScript Engine</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/testing-library/">Testing Library</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/rendering-engine/">Rendering Engine</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/mocking-library/">Mocking Library</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/stylesheet-engine/">Stylesheet Engine</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/adding-components/locale-translations/">Locale Translations</a></li></ul><h5 class="sidebar__header"><a href="/guides/advanced-usage/overview/">Advanced Usage</a></h5><ul class="sidebar__items"><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/overview/">Overview</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/extending-padrino-projects/">Extending Padrino Projects</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/3rd-party-plugins/">3rd Party Plugins</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/asynchronous-concurrency-with-padrino/">Asyncronous Concurrency</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/grape-with-padrino/">Grape with Padrino</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/running-padrino-on-jruby/">Running Padrino on JRuby</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/standalone-usage-in-sinatra/">Standalone Usage in Sinatra</a></li><li class="sidebar__item"><a class="sidebar__link" href="/guides/advanced-usage/padrino-and-omniauth-overview/">Padrino and OmniAuth Overview</a></li></ul></div></div><div class="page__content"><div class="content"><p class="content__chapter-title">Advanced Usage</p><h1 id="padrino-and-omniauth-overview">Padrino and OmniAuth Overview</h1>
<p>This article will show you how to mix our <a href="https://github.com/padrino/padrino-framework/blob/master/padrino-admin/lib/padrino-admin/access_control.rb">Access Control</a> described <a href="/guides/features/padrino-admin/">here</a> with the beautiful <a href="https://github.com/intridea/omniauth">omniauth</a> rack middleware.</p>

<p>The Padrino admin authentication and access control system provides a simple foundation from which you can create your authentication system. Combined with <a href="https://github.com/intridea/omniauth">omniauth</a> you can then easily leverage the system to allow authentication through a variety of methods. Read below for more details on how to integrate them.</p>

<p><break></p>

<p>In this article we’ll cover two topics:</p>

<ul>
<li>1) Integrating Padrino Admin Authentication into all apps within your project</li>
<li>2) Enabling custom authentication strategies within the authentication system</li>
</ul>

<p>Before we begin, it is important to note that our integrated authentication based on project-roles can interact easily with other systems. The only files that need to be changed are <code>session.rb</code> and <code>account.rb</code> in order to add your own custom code.</p>

<p>So, let’s start by creating a project using activerecord:</p>
<pre class="syntax plaintext"><code>$ padrino g project foo --orm activerecord --tiny
$ cd foo
$ bundle install
</code></pre>

<p>Now we need to add a model called <code>Account</code> to act as our persistence model:</p>
<pre class="syntax plaintext"><code>$ padrino g model Account name:string email:string role:string uid:string provider:string
</code></pre>

<p>Now we need to create and migrate our database:</p>
<pre class="syntax plaintext"><code>$ padrino rake ar:create ar:migrate
</code></pre>

<p>NOTE: If your migration fails with something like this</p>

<p><code>Directly inheriting from ActiveRecord::Migration is not supported. Please specify the Rails release the migration was written ...</code></p>

<p>then you need to update the <code>db/migrate/001_create_account.rb</code> with
   <code>class CreateAccounts &lt; ActiveRecord::Migration[4.2]</code></p>

<p>Open your favorite editor and browse and edit <code>Gemfile</code> and add <code>omniauth</code> gem and the providers for twitter and facebook.
We also add the <code>haml</code> gem as it&#39;s not included by default in the &quot;tiny&quot; padrino template:</p>
<pre class="syntax plaintext"><code># Gemfile
gem 'omniauth'
gem 'omniauth-twitter'
gem 'omniauth-facebook'
gem 'haml'
</code></pre>

<p>Now, run bundle install to install dependencies:</p>
<pre class="syntax plaintext"><code>$ bundle install
</code></pre>

<p>Now we need to add the <code>omniauth middleware</code>. Here you can choose two ways:</p>

<ul>
<li>1) Add the middleware project-wide (so every subapp can use it)</li>
<li>2) Add the middleware only to the one app that requires it</li>
</ul>

<p>In our example, we need to edit simply <code>app/app.rb</code> and add:</p>
<pre class="syntax plaintext"><code># app/app.rb
use OmniAuth::Builder do
  provider :twitter,  'consumer_key', 'consumer_secret'
  provider :facebook, 'app_id', 'app_secret'
end
</code></pre>

<p>If you are in a multiapp scenario you need to edit <code>config/boot.rb</code>:</p>
<pre class="syntax plaintext"><code># config/boot.rb
Padrino.use OmniAuth::Builder do
  provider :twitter,  'consumer_key', 'consumer_secret'
  provider :facebook, 'app_id', 'app_secret'
end

# before the line
Padrino.load!
</code></pre>

<p>To obtain an app_id and secret for Facebook, you need to:</p>

<ul>
<li>Go to the <a href="http://www.facebook.com/developers">Facebook Developers Page</a></li>
<li>Browse and click <a href="http://www.facebook.com/developers/createapp.php">create a new app</a></li>
<li>Set your app name and complete the form…</li>
<li>One you finish that you are allowed to edit your settings, go to <strong>website</strong> section</li>
<li>Add to site url: <code>http://localhost:3000</code></li>
<li>Add to domain: <code>localhost</code></li>
<li>Write the <strong>Application ID</strong> and <strong>Application Secret</strong> to the <code>OmniAuth::Builder</code></li>
</ul>

<p>To obtain a consumer_key and consumer_secret for Twitter, you need to:</p>

<ul>
<li>Go to <a href="https://developer.twitter.com/apps/new">Twitter Applications Page</a></li>
<li>Insert all details and be sure to check <strong>Application Type: Browser</strong></li>
<li>Set a callback url with a valid domain ex: <code>www.mydomain.com/auth/twitter/callback</code></li>
<li>Save and go to <strong>Application Settings</strong> and <strong>Manage Domains</strong></li>
<li>Be sure that you can see your example domain: <code>www.mydomain.com/auth/twitter/callback</code></li>
<li>Authorize domain: <code>localhost</code></li>
<li>Now go to <strong>Application Details</strong> and save <code>Consumer key</code> and <code>Consumer Secret</code> to the <code>OmniAuth::Builder</code></li>
</ul>

<p><strong>NOTE</strong>: For domain, it is not important that this path exist because <code>omniauth</code> changes the callback url.</p>

<p>Next, we can integrate our authentication system within in <code>app/app.rb</code>:</p>
<pre class="syntax plaintext"><code># app/app.rb
# at the top after the enable :sessions
register Padrino::Admin::AccessControl

set :login_page, "/" # determines the url login occurs

access_control.roles_for :any do |role|
  role.protect "/profile"
  role.protect "/admin" # here is a demo path
end

# now we add a role for users
access_control.roles_for :users do |role|
  role.allow "/profile"
end
</code></pre>

<p>And add a couple useful routes, edit <code>app/controllers.rb</code> with:</p>
<pre class="syntax plaintext"><code># app/controllers.rb
get :index do
  haml &lt;&lt;-HAML.gsub(/^ {6}/, '')
    Login with
    =link_to('Facebook', '/auth/facebook')
    or
    =link_to('Twitter',  '/auth/twitter')
  HAML
end

get :profile do
  content_type :text
  current_account.to_yaml
end

get :destroy do
  set_current_account(nil)
  redirect url(:index)
end

get :auth, :map =&gt; '/auth/:provider/callback' do
  auth    = request.env["omniauth.auth"]
  account = Account.find_by_provider_and_uid(auth["provider"], auth["uid"]) ||
            Account.create_with_omniauth(auth)
  set_current_account(account)
  redirect "http://" + request.env["HTTP_HOST"] + url(:profile)
end
</code></pre>

<p>We invoked a method <code>Account.create_with_omniauth</code> above, so edit <code>app/models/account.rb</code> and add:</p>
<pre class="syntax plaintext"><code># app/models/account.rb
def self.create_with_omniauth(auth)
  create! do |account|
    account.provider = auth["provider"]
    account.uid      = auth["uid"]
    account.name    = auth["info"]["name"] if auth["info"]
    account.email    = auth["info"]["email"] if auth["info"] # we get this only from FB
    account.role     = "users"
  end
end
</code></pre>

<p>That should just about do it! Let’s start the server:</p>
<pre class="syntax plaintext"><code>$ padrino start
</code></pre>

<p>Browse <a href="http://localhost:3000/profile">http://localhost:3000/profile</a></p>

<p>That will kickoff to the login_page, in our case <code>/</code>.</p>

<p>Now you can login here <a href="http://localhost:3000">http://localhost:3000</a></p>

<p>Follow your login process and then if needed <a href="http://localhost:3000/destroy">http://localhost:3000/destroy</a></p>

<p>That is all you need to setup a barebones authentication system in Padrino. This post has gotten you started with a working “Account” and role based authentication solution with integrated omniauth support. From here, obviously there are a number of other features you might want to add on top to flesh out, and that is left for another post or as an exercise to the reader.</p>
<p class="updated"> last updated: 2017-06-19</p><div id='disqus_thread'></div>
<script type='text/javascript'>
//<![CDATA[
                  var disqus_shortname = 'padrinorb';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>
<a href='http://disqus.com' class='dsq-brlink'>comments powered by <span class='logo-disqus'>Disqus</span></a>
</div></div></div><hr /><footer class="footer"><p>Padrino is released under the MIT LICENSE<br/>
Hosting by <a title="GitHub Pages" href="https://pages.github.com">GitHub Pages</a><br/>
Logo design by <a title="unpolo" href="https://www.unpolo.com/">unpolo</a></p>
<script>anchors.add('').remove('.sidebar h4, .sidebar h5, .header h1');</script></footer></div></body></html>